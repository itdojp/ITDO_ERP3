# 勤怠管理（最小機能）モジュール詳細仕様書
## HR Attendance (Minimum) Module Specification

### 1. モジュール概要

#### 1.1 目的
36協定管理および労働基準法遵守のため、MVP段階で必要最小限の勤怠管理機能を提供する。既存勤怠システムとの連携も考慮し、法的要件を確実に満たす。

#### 1.2 適用範囲
- **打刻管理**（MVP必須、36協定対応）
- **時間外労働管理**（MVP必須、上限チェック）
- **月次勤怠締め**（MVP必須）
- **既存勤怠システム連携IF**（Should Have）

#### 1.3 対象ユーザー
- 従業員（打刻、申請）
- 上長（承認、確認）
- 人事担当者（管理、レポート）
- システム管理者（設定、連携）

---

### 2. 機能要件

#### 2.1 打刻管理 ★MVP必須

##### 機能ID: HR-ATT-001 - 基本打刻
**優先度**: MVP必須

**機能概要**
従業員の出退勤時刻を正確に記録し、労働時間の適正把握を実現する。

**詳細要件**
- **打刻種別**：出勤、退勤、休憩開始、休憩終了
- **打刻方法**：WebUI、モバイルアプリ、ICカード連携
- **位置情報記録**：GPS連携（在宅勤務判定）
- **打刻修正**：申請ベースの修正機能（承認必須）
- **打刻忘れ対応**：自動アラート、後付け申請機能

**入力項目**
| 項目名 | 必須 | データ型 | 桁数 | 備考 |
|--------|------|----------|------|------|
| 従業員ID | ○ | VARCHAR | 10 | |
| 打刻日時 | ○ | DATETIME | - | |
| 打刻種別 | ○ | ENUM | - | 出勤/退勤/休憩開始/休憩終了 |
| 打刻場所 | ○ | ENUM | - | 社内/在宅/外出先 |
| 位置情報 | △ | JSON | - | GPS座標 |
| 修正理由 | △ | TEXT | 200 | 修正時必須 |

##### 機能ID: HR-ATT-002 - 労働時間計算
**優先度**: MVP必須

**機能概要**
打刻データから法定労働時間、時間外労働時間を正確に算出する。

**詳細要件**
- **所定労働時間**：8時間/日、40時間/週の基準管理
- **休憩時間**：自動控除（1時間/日）、手動調整可能
- **時間外区分**：
  - 法定内時間外（所定時間超～8時間）
  - 法定外時間外（8時間超）
  - 深夜労働（22:00～5:00）
  - 休日労働（法定休日、所定休日）
- **端数処理**：15分単位、月末一括調整

#### 2.2 36協定管理 ★MVP必須

##### 機能ID: HR-ATT-003 - 時間外上限管理
**優先度**: MVP必須

**機能概要**
36協定に基づく時間外労働の上限を管理し、違反を未然に防止する。

**詳細要件**
- **上限設定**：
  - 月45時間（年360時間）の原則上限
  - 特別条項：月100時間未満、2～6ヶ月平均80時間以内
  - 年720時間の上限
- **リアルタイムチェック**：
  - 退勤打刻時の上限チェック
  - 警告表示（80%、90%、100%到達時）
  - 管理者への自動通知
- **特別条項管理**：
  - 特別条項の発動申請・承認
  - 月6回までの制限管理

**36協定チェック項目**
| チェック項目 | 上限値 | チェックタイミング | アクション |
|--------------|--------|------------------|------------|
| 月間時間外 | 45時間 | 退勤打刻時 | 警告表示 |
| 月間時間外（特別） | 100時間 | 退勤打刻時 | 承認必須 |
| 2～6ヶ月平均 | 80時間 | 月次処理時 | 管理者通知 |
| 年間時間外 | 720時間 | 月次処理時 | 管理者通知 |
| 特別条項回数 | 6回/年 | 月次処理時 | 制限アラート |

##### 機能ID: HR-ATT-004 - 勤怠アラート機能
**優先度**: MVP必須

**機能概要**
労働時間の異常や法令違反リスクを早期に検出し、関係者に通知する。

**詳細要件**
- **従業員向け**：
  - 打刻忘れアラート（出勤後2時間、退勤予定時刻）
  - 時間外上限接近通知（80%、90%到達）
  - 連続勤務日数警告（6日連続時）
- **管理者向け**：
  - 時間外上限違反リスク通知
  - 未承認勤怠一覧（月次締め前）
  - 法令違反可能性アラート

#### 2.3 月次勤怠管理 ★MVP必須

##### 機能ID: HR-ATT-005 - 月次締め処理
**優先度**: MVP必須

**機能概要**
月次での勤怠確定処理により、給与計算・労働時間管理の基礎データを確定する。

**詳細要件**
- **締め処理**：
  - 月末の勤怠データ確定
  - 未打刻・未承認データの確認
  - 労働時間集計（所定、時間外、深夜、休日）
  - 36協定遵守チェック
- **承認フロー**：
  - 本人確認→上長承認→人事確認の3段階
  - 一括承認機能（条件設定可能）
  - 差戻し・再申請機能
- **データ連携**：
  - タイムシートシステムへの実働時間連携
  - 給与システムへの勤怠データ連携

#### 2.4 既存システム連携 ★Should Have

##### 機能ID: HR-ATT-006 - 勤怠システム連携
**優先度**: Should Have

**機能概要**
既存勤怠システム（kintone、TeamSpirit等）との連携により、運用負荷を軽減する。

**詳細要件**
- **連携方式**：
  - API連携（REST/GraphQL）
  - CSVファイル連携（日次/月次）
  - Webhook連携（リアルタイム）
- **連携データ**：
  - 打刻データ（入退勤時刻）
  - 労働時間データ（所定、時間外、休日）
  - 承認状況データ
- **データ同期**：
  - 双方向同期（マスターシステム設定可能）
  - 差分同期（変更分のみ）
  - エラーハンドリング・再試行機能

---

### 3. データモデル

#### 3.1 主要エンティティ

```sql
-- 打刻データ
CREATE TABLE attendance_records (
    record_id VARCHAR(20) PRIMARY KEY,
    employee_id VARCHAR(10) NOT NULL,
    record_date DATE NOT NULL,
    punch_type ENUM('出勤','退勤','休憩開始','休憩終了') NOT NULL,
    punch_time DATETIME NOT NULL,
    location_type ENUM('社内','在宅','外出先') NOT NULL,
    gps_data JSON,
    is_corrected BOOLEAN DEFAULT FALSE,
    correction_reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 日次労働時間サマリー
CREATE TABLE daily_work_summary (
    summary_id VARCHAR(20) PRIMARY KEY,
    employee_id VARCHAR(10) NOT NULL,
    work_date DATE NOT NULL,
    scheduled_hours DECIMAL(5,2) NOT NULL, -- 所定労働時間
    actual_hours DECIMAL(5,2) NOT NULL,    -- 実労働時間
    overtime_hours DECIMAL(5,2) DEFAULT 0, -- 時間外労働時間
    night_hours DECIMAL(5,2) DEFAULT 0,    -- 深夜労働時間
    holiday_hours DECIMAL(5,2) DEFAULT 0,  -- 休日労働時間
    break_hours DECIMAL(5,2) DEFAULT 1,    -- 休憩時間
    approval_status ENUM('未申請','申請中','承認済','差戻') DEFAULT '未申請',
    UNIQUE KEY idx_employee_date (employee_id, work_date)
);

-- 36協定管理
CREATE TABLE overtime_limits (
    limit_id VARCHAR(20) PRIMARY KEY,
    employee_id VARCHAR(10) NOT NULL,
    fiscal_year YEAR NOT NULL,
    monthly_limit INTEGER DEFAULT 45,      -- 月間上限（時間）
    yearly_limit INTEGER DEFAULT 360,      -- 年間上限（時間）
    special_limit INTEGER DEFAULT 100,     -- 特別条項月間上限
    special_count_limit INTEGER DEFAULT 6, -- 特別条項回数上限
    is_active BOOLEAN DEFAULT TRUE,
    UNIQUE KEY idx_employee_year (employee_id, fiscal_year)
);

-- 月次勤怠サマリー
CREATE TABLE monthly_attendance (
    monthly_id VARCHAR(20) PRIMARY KEY,
    employee_id VARCHAR(10) NOT NULL,
    year_month CHAR(7) NOT NULL, -- YYYY-MM
    total_work_days INTEGER DEFAULT 0,
    total_work_hours DECIMAL(6,2) DEFAULT 0,
    total_overtime_hours DECIMAL(6,2) DEFAULT 0,
    total_night_hours DECIMAL(6,2) DEFAULT 0,
    total_holiday_hours DECIMAL(6,2) DEFAULT 0,
    special_overtime_count INTEGER DEFAULT 0, -- 特別条項使用回数
    is_closed BOOLEAN DEFAULT FALSE,
    closed_at TIMESTAMP NULL,
    UNIQUE KEY idx_employee_month (employee_id, year_month)
);
```

---

### 4. 外部システム連携

#### 4.1 タイムシートシステム連携
- **連携先**: 財務管理モジュール（FI）
- **連携データ**: 実働時間データ
- **連携方式**: API（リアルタイム）
- **連携タイミング**: 勤怠承認完了時

#### 4.2 既存勤怠システム連携
- **対象システム**: kintone、TeamSpirit、AKASHI等
- **連携方式**: REST API、CSV、Webhook
- **同期頻度**: 日次（夜間バッチ）、リアルタイム（Webhook）

#### 4.3 人事システム連携
- **連携データ**: 従業員マスター、組織情報、勤務パターン
- **連携方式**: API（日次同期）
- **連携内容**: 入退職情報、組織変更、労働条件変更

---

### 5. 法令遵守要件

#### 5.1 労働基準法対応
- **労働時間の適正把握**: 客観的記録による労働時間把握
- **休憩時間の確保**: 6時間超で45分、8時間超で1時間
- **法定休日の管理**: 週1回以上の休日確保チェック
- **年次有給休暇**: 取得状況の把握（Phase 2で詳細実装）

#### 5.2 36協定遵守
- **時間外労働の上限**: 月45時間、年360時間の原則
- **特別条項**: 月100時間未満、2～6ヶ月平均80時間以内
- **休日労働の制限**: 月100時間未満の範囲内

#### 5.3 記録保存義務
- **保存期間**: 3年間（労働者名簿と同期間）
- **記録内容**: 労働時間、休憩時間、休日労働時間
- **改ざん防止**: タイムスタンプ、ハッシュ値による真正性確保

---

### 6. 実装優先度

#### 6.1 MVP（Phase 1: 0-6ヶ月）必須機能
- HR-ATT-001: 基本打刻（Web/モバイル）
- HR-ATT-002: 労働時間計算（法定区分）
- HR-ATT-003: 36協定上限管理（リアルタイムチェック）
- HR-ATT-004: 勤怠アラート（基本通知）
- HR-ATT-005: 月次締め処理（承認フロー）

#### 6.2 Phase 2（7-12ヶ月）拡張機能
- HR-ATT-006: 既存システム連携
- 有給休暇管理
- シフト勤務対応
- 詳細レポート機能
- BI連携（ダッシュボード）

---

### 7. 完成の定義（DoD）

#### 7.1 MVP完了条件
- [ ] 36協定上限チェックが正しく動作（月45時間超で警告）
- [ ] 打刻データから法定労働時間区分が正確に計算される
- [ ] 月次締めで未承認データが検出され、承認フローが完動
- [ ] タイムシートシステムへの実働時間連携が正常動作
- [ ] 法定保存期間（3年）でのデータ保持・検索が可能

#### 7.2 受入れテストシナリオ
1. **36協定違反防止**: 月44時間時点で警告、45時間で管理者通知、特別条項申請フロー
2. **労働時間計算**: 9:00-18:00勤務（休憩1時間）で所定8時間、残業2時間で法定外2時間
3. **月次締め**: 未打刻検出→修正申請→承認→タイムシート連携の一連処理

---

**注記**: 本仕様は36協定および労働基準法遵守のための最小機能セットです。より詳細な人事機能はPhase 2のHRモジュールで実装予定です。
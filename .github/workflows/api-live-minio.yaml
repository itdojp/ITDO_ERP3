name: api-live-minio

on:
  workflow_dispatch:

jobs:
  api-live:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    env:
      PM_PORT: 3101
      FORCE_PM_PORT: 3001
      UI_PORT: 4100
      USE_MINIO: true
      E2E_EXPECT_API: true
      E2E_REQUIRE_MINIO: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci
        working-directory: ui-poc

      - name: Install playwright
        run: npx playwright install --with-deps chromium
        working-directory: ui-poc

      - name: Run podman live tests
        run: |
          sudo apt-get update
          sudo apt-get install -y podman podman-compose
          FORCE_PM_PORT=3001 PM_PORT=3101 UI_PORT=4100 USE_MINIO=true UI_HEADLESS=true scripts/run_podman_ui_poc.sh --tests-only

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: ui-poc/playwright-report
          if-no-files-found: ignore

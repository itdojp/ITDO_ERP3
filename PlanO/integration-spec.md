# 統合・連携仕様書

## 1. 概要

### 1.1 目的
本仕様書は、ERPシステムの各モジュール間の連携、外部システムとの統合、データ連携の要件を定義し、シームレスな業務プロセスの実現を図る。

### 1.2 適用範囲
- モジュール間インターフェース
- マスターデータ同期
- トランザクションデータ連携
- 外部システム統合
- データ整合性管理

### 1.3 連携方針
- リアルタイム連携の優先
- 疎結合アーキテクチャ
- イベント駆動型連携
- 標準プロトコルの採用
- エラーハンドリングの徹底

## 2. モジュール間連携マトリックス

### 2.1 連携関係一覧

| 送信元 | 送信先 | 連携データ | 連携方式 | 頻度 | 優先度 |
|--------|--------|------------|----------|------|--------|
| 販売管理 | 在庫管理 | 受注・出荷情報 | API（同期） | リアルタイム | 必須 |
| 販売管理 | 財務管理 | 売上・売掛金 | API（非同期） | 日次 | 必須 |
| 販売管理 | CRM | 受注・顧客情報 | イベント | リアルタイム | 必須 |
| 在庫管理 | 財務管理 | 在庫評価額 | バッチ | 月次 | 必須 |
| 在庫管理 | 購買管理 | 発注点情報 | API（同期） | リアルタイム | 高 |
| 購買管理 | 財務管理 | 仕入・買掛金 | API（非同期） | 日次 | 必須 |
| 購買管理 | 在庫管理 | 入荷情報 | イベント | リアルタイム | 必須 |
| 生産管理 | 在庫管理 | 生産実績 | API（同期） | リアルタイム | 高 |
| 生産管理 | 購買管理 | 資材所要量 | バッチ | 日次 | 高 |
| プロジェクト管理 | 財務管理 | プロジェクトコスト | API（非同期） | 日次 | 必須 |
| プロジェクト管理 | 人事管理 | 工数実績 | API（同期） | リアルタイム | 必須 |
| 人事管理 | 財務管理 | 給与・経費 | バッチ | 月次 | 必須 |
| CRM | 販売管理 | 商談→受注 | API（同期） | リアルタイム | 必須 |
| CRM | マーケティング | リード情報 | イベント | リアルタイム | 高 |
| BI | 全モジュール | 分析用データ | ETL | 日次 | 高 |

### 2.2 データフロー定義

#### 2.2.1 受注→出荷→売上フロー
```
[CRM] 商談成立
    ↓ API
[販売管理] 受注登録
    ↓ イベント
[在庫管理] 在庫引当
    ↓ API
[販売管理] 受注確定
    ↓ API
[物流管理] 出荷指示
    ↓ イベント
[在庫管理] 在庫減少
    ↓ API
[販売管理] 売上計上
    ↓ バッチ
[財務管理] 売掛金計上
```

#### 2.2.2 購買→入荷→支払フロー
```
[在庫管理] 発注点到達
    ↓ API
[購買管理] 発注依頼
    ↓ 承認
[購買管理] 発注確定
    ↓ EDI
[外部] サプライヤー
    ↓ 納品
[在庫管理] 入荷検収
    ↓ イベント
[購買管理] 仕入計上
    ↓ バッチ
[財務管理] 買掛金計上
```

## 3. インターフェース仕様

### 3.1 API仕様

#### 3.1.1 共通API仕様
| 項目 | 仕様 | 備考 |
|------|------|------|
| プロトコル | HTTPS (TLS 1.3) | 暗号化必須 |
| データ形式 | JSON | Content-Type: application/json |
| 文字コード | UTF-8 | |
| 認証方式 | Bearer Token (JWT) | OAuth 2.0 |
| APIバージョニング | URLパス方式 | /api/v1/, /api/v2/ |
| エラーレスポンス | RFC 7807準拠 | application/problem+json |

#### 3.1.2 主要API定義

##### 受注API
```json
POST /api/v1/sales/orders
{
  "orderNumber": "ORD-2024-001234",
  "customerId": "CUST-12345",
  "orderDate": "2024-03-01T10:00:00Z",
  "deliveryDate": "2024-03-15T00:00:00Z",
  "items": [
    {
      "productId": "PROD-001",
      "quantity": 100,
      "unitPrice": 1000,
      "discount": 0.1
    }
  ],
  "shippingAddress": {},
  "paymentTerms": "NET30"
}

Response: 201 Created
{
  "orderId": "uuid-12345",
  "status": "CONFIRMED",
  "totalAmount": 90000,
  "creditCheckResult": "APPROVED"
}
```

##### 在庫引当API
```json
POST /api/v1/inventory/allocations
{
  "orderId": "uuid-12345",
  "items": [
    {
      "productId": "PROD-001",
      "quantity": 100,
      "warehouseId": "WH-001"
    }
  ]
}

Response: 200 OK
{
  "allocationId": "ALLOC-98765",
  "status": "ALLOCATED",
  "allocatedItems": [
    {
      "productId": "PROD-001",
      "allocatedQty": 100,
      "backorderQty": 0
    }
  ]
}
```

### 3.2 イベント駆動連携

#### 3.2.1 イベント仕様
| 項目 | 仕様 | 備考 |
|------|------|------|
| メッセージング基盤 | Apache Kafka | Confluent Cloud可 |
| メッセージ形式 | Apache Avro | スキーマレジストリ使用 |
| イベント命名規則 | domain.entity.action | sales.order.created |
| 配信保証 | At Least Once | 冪等性確保必須 |
| パーティショニング | エンティティID | 順序保証 |

#### 3.2.2 主要イベント定義

##### 受注作成イベント
```json
{
  "eventId": "evt-uuid-12345",
  "eventType": "sales.order.created",
  "timestamp": "2024-03-01T10:00:00Z",
  "source": "sales-service",
  "data": {
    "orderId": "uuid-12345",
    "customerId": "CUST-12345",
    "totalAmount": 90000,
    "items": []
  },
  "metadata": {
    "correlationId": "corr-98765",
    "userId": "user-001"
  }
}
```

##### 在庫変動イベント
```json
{
  "eventId": "evt-uuid-67890",
  "eventType": "inventory.stock.changed",
  "timestamp": "2024-03-01T10:05:00Z",
  "source": "inventory-service",
  "data": {
    "productId": "PROD-001",
    "warehouseId": "WH-001",
    "changeType": "ALLOCATION",
    "quantity": -100,
    "currentStock": 900,
    "referenceId": "ALLOC-98765"
  }
}
```

### 3.3 バッチ連携

#### 3.3.1 バッチ連携仕様
| 項目 | 仕様 | 備考 |
|------|------|------|
| ファイル形式 | CSV/JSON/XML | 用途別選択 |
| 文字コード | UTF-8 BOM無し | |
| 改行コード | LF | |
| ファイル転送 | SFTP/S3 | 暗号化必須 |
| ファイル命名規則 | system_data_yyyymmdd_hhmmss | |
| 圧縮形式 | gzip | 大容量ファイル |

#### 3.3.2 主要バッチ連携

##### 売上日次連携
| 項目 | 仕様 |
|------|------|
| ファイル名 | sales_daily_20240301_020000.csv |
| 実行時刻 | 毎日 02:00 |
| データ項目 | 売上日,顧客コード,商品コード,数量,金額,税額 |
| レコード数 | 約10,000件/日 |
| エラー処理 | エラーレコードを別ファイル出力 |

##### 在庫月次連携
| 項目 | 仕様 |
|------|------|
| ファイル名 | inventory_monthly_202403_010000.json |
| 実行時刻 | 月初 01:00 |
| データ形式 | JSON Lines |
| レコード数 | 約50,000件 |
| リトライ | 3回（10分間隔） |

## 4. マスターデータ同期

### 4.1 同期対象マスター

#### 4.1.1 マスターデータ一覧
| マスター種別 | 管理元 | 同期先 | 同期方式 | 同期頻度 |
|-------------|--------|--------|----------|----------|
| 顧客マスター | CRM | 販売,財務,BI | CDC | リアルタイム |
| 商品マスター | 商品管理 | 販売,在庫,購買 | イベント | リアルタイム |
| 従業員マスター | 人事 | 全モジュール | バッチ | 日次 |
| 組織マスター | 人事 | 全モジュール | API | リアルタイム |
| 取引先マスター | 購買 | 財務,契約 | CDC | リアルタイム |
| 勘定科目マスター | 財務 | 全モジュール | バッチ | 月次 |

#### 4.1.2 同期方式詳細

##### CDC（Change Data Capture）方式
```
[マスター変更] → [変更検知] → [差分抽出] → [同期処理] → [確認]
                    ↓
                [変更ログ記録]
```

##### イベント方式
```
[マスター変更] → [イベント発行] → [イベントバス] → [サブスクライバー]
                                        ↓
                                  [イベントストア]
```

### 4.2 データ整合性管理

#### 4.2.1 整合性チェック
| チェック種別 | 実施タイミング | 対象 | アクション |
|-------------|---------------|------|-----------|
| 参照整合性 | リアルタイム | 外部キー | エラー返却 |
| 重複チェック | 登録時 | ユニークキー | 警告/拒否 |
| 必須チェック | 登録/更新時 | 必須項目 | エラー返却 |
| 範囲チェック | 登録/更新時 | 数値/日付 | エラー返却 |
| 相関チェック | バッチ（日次） | 関連データ | レポート出力 |

#### 4.2.2 不整合時の対処
| 不整合パターン | 検出方法 | 対処方法 | 通知先 |
|---------------|----------|----------|--------|
| マスター不一致 | 定期突合 | 自動補正 or 手動修正 | システム管理者 |
| 欠損データ | 参照エラー | デフォルト値設定 | データ管理者 |
| 重複データ | 重複検知 | マージ or 削除 | データ管理者 |
| 不正データ | 検証エラー | リジェクト | 業務担当者 |

## 5. 外部システム連携

### 5.1 連携システム一覧

| システム種別 | システム名 | 連携内容 | 連携方式 | 頻度 |
|-------------|-----------|----------|----------|------|
| 銀行システム | 全銀協 | 入出金明細 | 全銀TCP/IP | 日次 |
| 税務システム | e-Tax/eLTAX | 申告データ | Web API | 月次/年次 |
| EDI | 流通BMS | 受発注 | AS2 | リアルタイム |
| ECサイト | 自社EC | 受注情報 | REST API | リアルタイム |
| 配送システム | ヤマト/佐川 | 配送状況 | Web API | 随時 |
| 決済システム | GMO/Stripe | 決済情報 | Webhook | リアルタイム |
| 名刺管理 | Sansan | 顧客情報 | REST API | 日次 |
| 経費精算 | Concur | 経費データ | SFTP | 日次 |
| 電子契約 | DocuSign | 契約書 | REST API | 随時 |
| BI/Analytics | Tableau | 分析データ | JDBC/ODBC | 随時 |

### 5.2 EDI連携仕様

#### 5.2.1 流通BMS対応
| 項目 | 仕様 | 備考 |
|------|------|------|
| 通信プロトコル | AS2/SFTP | |
| メッセージ形式 | XML (流通BMS標準) | |
| 文字コード | UTF-8 | |
| 暗号化 | S/MIME | |
| 電子署名 | 必須 | |

#### 5.2.2 対応メッセージ
| メッセージ種別 | 方向 | 用途 |
|---------------|------|------|
| 発注メッセージ | 受信 | 受注登録 |
| 発注請けメッセージ | 送信 | 受注確認 |
| 出荷案内メッセージ | 送信 | 出荷通知 |
| 受領メッセージ | 受信 | 納品確認 |
| 請求メッセージ | 送信 | 請求通知 |
| 支払案内メッセージ | 受信 | 入金確認 |

### 5.3 金融機関連携

#### 5.3.1 全銀協連携
| 項目 | 仕様 | 備考 |
|------|------|------|
| 通信方式 | 全銀TCP/IP手順 | |
| 接続方式 | VPN | |
| データ形式 | 全銀フォーマット | |
| 文字コード | JIS | |
| 伝送時刻 | 9:00, 14:00, 18:00 | |

#### 5.3.2 連携データ
| データ種別 | 方向 | タイミング |
|-----------|------|-----------|
| 振込依頼 | 送信 | 随時 |
| 入出金明細 | 受信 | 日次 |
| 残高照会 | 受信 | 随時 |
| 口座振替依頼 | 送信 | 月次 |
| 振替結果 | 受信 | 月次 |

## 6. 連携エラー処理

### 6.1 エラー種別と対処

| エラー種別 | 検出方法 | リトライ | エスカレーション | 対処方法 |
|-----------|----------|----------|------------------|----------|
| 通信エラー | タイムアウト | 3回（指数バックオフ） | 30分後 | 代替経路/手動 |
| 認証エラー | 401/403 | 1回 | 即時 | 認証情報確認 |
| データエラー | バリデーション | なし | 即時 | データ修正 |
| 容量超過 | 413/507 | なし | 即時 | 分割送信 |
| システムエラー | 500番台 | 3回（5分間隔） | 1時間後 | 手動介入 |

### 6.2 補償トランザクション

#### 6.2.1 Sagaパターン実装
```
[受注] → [在庫引当] → [与信確認] → [確定]
           ↓失敗         ↓失敗        ↓失敗
      [在庫引当取消] [引当取消]   [全取消]
                    [受注取消]    
```

#### 6.2.2 補償処理定義
| 処理 | 補償処理 | タイムアウト |
|------|----------|-------------|
| 在庫引当 | 引当解除 | 30秒 |
| 与信確保 | 与信解放 | 60秒 |
| 出荷指示 | 出荷取消 | 5分 |
| 決済処理 | 返金処理 | 24時間 |

## 7. 連携監視

### 7.1 監視項目

| 監視対象 | 監視内容 | 閾値 | アラート |
|---------|---------|------|----------|
| API応答時間 | レスポンスタイム | >3秒 | Warning |
| APIエラー率 | エラー/総リクエスト | >1% | Critical |
| メッセージ遅延 | キュー滞留時間 | >5分 | Warning |
| バッチ処理時間 | 実行時間 | >想定×1.5 | Warning |
| データ不整合 | 突合チェック | 不一致検出 | Critical |

### 7.2 監視ダッシュボード

#### 7.2.1 リアルタイム監視
- API呼び出し回数（/分）
- 平均応答時間
- エラー発生状況
- システム間データフロー
- メッセージキュー状態

#### 7.2.2 定期レポート
- 日次連携実績
- エラー統計
- パフォーマンス推移
- SLA達成状況

## 8. データ変換・マッピング

### 8.1 データ変換ルール

#### 8.1.1 コード変換
| 項目 | 変換元 | 変換先 | 変換ルール |
|------|--------|--------|------------|
| 顧客コード | 外部（10桁） | 内部（8桁） | 先頭2桁削除 |
| 商品コード | JAN（13桁） | 内部（10桁） | マッピングテーブル |
| 日付 | YYYYMMDD | YYYY-MM-DD | フォーマット変換 |
| 金額 | 税込 | 税抜 | 税率逆算 |

#### 8.1.2 単位変換
| 項目 | 変換元 | 変換先 | 変換式 |
|------|--------|--------|--------|
| 数量 | ケース | 個 | ×入数 |
| 重量 | ポンド | キログラム | ×0.453592 |
| 通貨 | USD | JPY | ×為替レート |

### 8.2 マッピング定義

#### 8.2.1 フィールドマッピング例（受注）
| 外部フィールド | 内部フィールド | 変換処理 |
|---------------|---------------|----------|
| ORDER_NO | orderNumber | そのまま |
| CUST_CD | customerId | コード変換 |
| ORDER_DT | orderDate | 日付フォーマット |
| DLVR_DT | deliveryDate | 日付フォーマット |
| TTL_AMT | totalAmount | 税抜変換 |

## 9. 性能要件

### 9.1 連携性能目標

| 連携種別 | 性能指標 | 目標値 | 備考 |
|---------|---------|--------|------|
| 同期API | 応答時間 | <1秒 | 95パーセンタイル |
| 非同期API | 応答時間 | <100ms | ACK返却 |
| イベント処理 | レイテンシ | <500ms | End-to-End |
| バッチ転送 | スループット | 100MB/分 | |
| EDI | 処理時間 | <30秒/伝票 | |

### 9.2 負荷分散

#### 9.2.1 API Gateway設定
- ラウンドロビン負荷分散
- ヘルスチェック（10秒間隔）
- サーキットブレーカー（エラー率50%で遮断）
- レート制限（1000req/分/クライアント）

## 10. セキュリティ

### 10.1 連携セキュリティ

| 項目 | 要件 | 実装方法 |
|------|------|----------|
| 通信暗号化 | 必須 | TLS 1.3 |
| API認証 | OAuth 2.0 | JWT Bearer Token |
| メッセージ暗号化 | 機密データ | AES-256 |
| ファイル暗号化 | 必須 | PGP/GPG |
| 監査ログ | 全連携 | 5年保存 |

### 10.2 アクセス制御

#### 10.2.1 API アクセス制御
- IPアドレス制限
- APIキー管理
- スコープベース認可
- 利用量制限

## 11. 移行時の連携

### 11.1 段階的移行

| フェーズ | 期間 | 連携方式 | 備考 |
|---------|------|----------|------|
| Phase 1 | 1ヶ月 | 新旧並行（Read） | 参照は両システム |
| Phase 2 | 2ヶ月 | 新旧並行（Write） | 更新は新システム |
| Phase 3 | 1ヶ月 | 同期処理 | データ同期確認 |
| Phase 4 | - | 新システムのみ | 旧システム停止 |

### 11.2 データ同期

#### 11.2.1 初期移行
- 全マスターデータの移行
- 過去トランザクション移行（2年分）
- 残高データの移行

#### 11.2.2 差分同期
- 日次差分バッチ
- リアルタイムCDC
- 双方向同期（並行稼働期間）

## 12. 用語定義

| 用語 | 定義 |
|------|------|
| API | Application Programming Interface |
| CDC | Change Data Capture - 変更データ抽出 |
| EDI | Electronic Data Interchange - 電子データ交換 |
| ETL | Extract Transform Load - データ抽出変換格納 |
| Saga | 分散トランザクションパターン |
| JWT | JSON Web Token |
| AS2 | Applicability Statement 2 - EDI通信プロトコル |
| 冪等性 | 同じ操作を複数回実行しても結果が同じになる性質 |